name: Check Slow Onset

on:
  # schedule:
  #  - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:
    inputs:
      FORCE_TRIGGER:
        description: 'FORCE_TRIGGER'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  check-monitoring:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - uses: astral-sh/setup-uv@v5
      - name: Run monitoring check
        env:
          HAPI_APP_IDENTIFIER: ${{ secrets.HAPI_APP_IDENTIFIER }}
          FORCE_TRIGGER: ${{ github.event.inputs.FORCE_TRIGGER || 'false' }}
        run: uv run check_slow_onset.py
      - name: Create PR if data changed
        run: |
          git add data/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Create branch name based on mode
          if [ "$FORCE_TRIGGER" = "true" ]; then
            BRANCH="test-run-$(date +%Y%m%d-%H%M%S)"
          else
            BRANCH="data-update-$(date +%Y%m%d-%H%M%S)"
          fi
          git checkout -b "$BRANCH"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update monitoring data"
          git push -u origin "$BRANCH"

          LABELS="send-email"
          BASE_BRANCH="main"
          if [ "$FORCE_TRIGGER" = "true" ]; then
            LABELS="$LABELS,test"
            # Create a new base branch off main for testing
            BASE_BRANCH="test-base-$(date +%Y%m%d-%H%M%S)"
            git branch "$BASE_BRANCH" main
            git push origin "$BASE_BRANCH"
          fi

          PR_URL=$(gh pr create --title "Update monitoring data" --body "Automated data update from slow onset check." --label "$LABELS" --base "$BASE_BRANCH")
          if [ -n "$PR_REVIEWER" ]; then
            gh pr edit "$PR_URL" --add-reviewer "$PR_REVIEWER"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_TRIGGER: ${{ github.event.inputs.FORCE_TRIGGER || 'false' }}
          PR_REVIEWER: ${{ vars.PR_REVIEWER }}