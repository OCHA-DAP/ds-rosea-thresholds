name: Check Slow Onset

on:
  # schedule:
  #  - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:
    inputs:
      force:
        description: 'Force update even if no changes'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      FORCE_TRIGGER:
        description: 'Force trigger for testing (adds "test" label to PR)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  check-monitoring:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Run monitoring check
        env:
          HAPI_APP_IDENTIFIER: ${{ secrets.HAPI_APP_IDENTIFIER }}
        run: uv run check_slow_onset.py ${{ github.event.inputs.force == 'true' && '--force' || '' }}
      - name: Create PR if data changed
        run: |
          git add data/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          BRANCH="data-update-$(date +%Y%m%d)"
          git checkout -b "$BRANCH"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update monitoring data"
          git push -u origin "$BRANCH"
          LABELS="send-email"
          if [ "$FORCE_TRIGGER" = "true" ]; then
            LABELS="$LABELS,test"
          fi
          gh pr create --title "Update monitoring data" --body "Automated data update from slow onset check." --label "$LABELS"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_TRIGGER: ${{ github.event.inputs.FORCE_TRIGGER || 'false' }}